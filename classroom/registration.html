<!-- Register page -->
<div id="classroom-register-container">
    <div class="inner-register-container">
        <form action="#" id="finalize-registration-form">
            <div class="form-group part-content-index part-row c-primary-form row">
                <div class="col-md-12">
                    <h3 class="font-weight-bold green-vitta text-center mb-4 text-uppercase"
                        data-i18n="superadmin.account.registration.title"></h3>
                    <p class="text-center" data-i18n="superadmin.account.registration.description"></p>
                </div>
                <div class="col-md-6">
                    <div>
                        <img src="assets/media/green_lock.png" class="icon-label">
                        <label for="profile-form-password" class="tutorial-label"
                            data-i18n="[html]superadmin.profil.password"></label>
                    </div>
                    <div class="form-inline">
                        <input type="password" name="password" id="profile-form-password"
                            class="form-control form-control-lg">
                        <i class="classroom-clickable fas fa-low-vision ml-2 password-display-toggler"></i>
                        <p class="font-italic ml-2" data-i18n="superadmin.profil.passwordConstraints"></p>
                    </div>
                </div>

                <div class="col-md-6">
                    <img src="assets/media/green_lock.png" class="icon-label">
                    <label for="profile-form-confirm-password" class="tutorial-label"
                        data-i18n="[html]superadmin.profil.confirmPassword"></label>
                    <div class="form-inline">
                        <input type="password" name="confirm-password" id="profile-form-confirm-password"
                            class="form-control form-control-lg">
                        <i class="classroom-clickable fas fa-low-vision ml-2 password-display-toggler"></i>
                    </div>
                </div>
            </div>

            <p data-i18n="[html]superadmin.account.registration.disclaimerVittascience"></p>
            <p data-i18n="[html]superadmin.account.registration.mandatory"></p>
            <p data-i18n="[html]superadmin.account.registration.cguVittascience"></p>

            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="cb_name_public">
                <label class="form-check-label" for="cb_name_public"
                    data-i18n="superadmin.account.registration.accountPublic">
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="cb_newsletter">
                <label class="form-check-label" for="cb_newsletter"
                    data-i18n="superadmin.account.registration.newsletter">
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="cb_alert_mail">
                <label class="form-check-label" for="cb_alert_mail"
                    data-i18n="superadmin.account.registration.mailAlert">
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="cb_allow_contact">
                <label class="form-check-label" for="cb_allow_contact"
                    data-i18n="superadmin.account.registration.allowContact">
                </label>
            </div>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="cb_adult" required>
                <label class="form-check-label" for="cb_adult" data-i18n="superadmin.account.registration.confirmAdult">
                </label>
            </div>

            <div class="col-md-12 d-flex flex-column align-items-center">
                <input class="btn browse-button mx-auto mt-3 btn-lg" type="submit"
                    data-i18n="[value]classroom.login.signup">
            </div>

        </form>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/8.1.0/i18next.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-i18next/1.2.1/jquery-i18next.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-xhr-backend/1.5.1/i18nextXHRBackend.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/2.2.3/i18nextBrowserLanguageDetector.min.js">
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script src="assets/js/utils/translate.js"></script>
<script src="assets/js/utils/get.js"></script>
<script src="assets/js/scripts/dashboardActivities.js"></script>
<script src="assets/js/scripts/displayPanel.js"></script>
<script src="assets/js/lib/EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script>
<script src="assets/js/scripts/signup.js"></script>
<script src="assets/js/main/Loader.js"></script>
<script src="assets/js/main/UIManager.js"></script>
<script src="assets/js/main/User.js"></script>
<script src="assets/js/main/ClassroomManager.js"></script>
<script src="assets/js/main/Main.js"></script>
<script src="assets/js/scripts/main-login.js"></script>
<script src="assets/js/scripts/login.js"></script>
<script src="assets/js/scripts/buttons.js"></script>

<script>
    /**
     * Check if the teacher's account update form values are correct
     * @returns {boolean} - true if check ok, false otherwise
     */
    function finalizeRegistrationFormCheck(formData) {

        let formValues = {
                'password': {
                    value: formData.get('password'),
                    id: 'profile-form-password'
                },
                'confirmPassword': {
                    value: formData.get('confirm-password'),
                    id: 'profile-form-confirm-password'
                }
            },
            errors = [];

        for (let input in formValues) {
            let currentElt = document.getElementById(formValues[input].id);
            if (currentElt.classList.contains('form-input-error')) {
                currentElt.classList.remove('form-input-error');
            }
        }

        if (!formValues.password.value.length > 7) {
            errors.push('invalidPassword');
            showFormInputError(formValues.password.id);
        }

        if (formValues.password.value != formValues.confirmPassword.value) {
            errors.push('passwordAndConfirmMismatch');
            showFormInputError(formValues.password.id);
            showFormInputError(formValues.confirmPassword.id);
        }

        if (errors.length) {
            for (let error of errors) {
                displayNotification('#notif-div', `classroom.notif.${error}`, "error");
            }
            return false;
        } else {
            return true;
        }
    }


    /**
     * Create teacher form submit listener
     */
    document.getElementById('finalize-registration-form').addEventListener('submit', (e) => {
        e.preventDefault();
        let data = new FormData(e.target);
        let token = getCookie('token');
        if (finalizeRegistrationFormCheck(data)) {
            finalizeRegistration(data, token).then((response) => {
                if (response.isUserAdded) {
                    $("#profile-form-password").val("");
                    $("#profile-form-confirm-password").val("");
                    displayNotification('#notif-div', "classroom.notif.accountCreated", "success");
                } else {
                    if (response.errorType) {
                        switch (response.errorType) {
                            case 'unknownUser':
                                displayNotification('#notif-div', "classroom.notif.unknownUser",
                                    "error");
                                break;
                            default:
                                break;
                        }
                    }
                    if (response.errors) {
                        for (let error in response.errors) {
                            displayNotification('#notif-div', `classroom.notif.${error}`, "error");
                        }
                    }
                }
            });
        }
    });
    /**
     * Create teacher account (registration)
     */
    function finalizeRegistration(formData, token) {
        return new Promise((resolve, reject) => {
            $.ajax({
                type: 'POST',
                url: '/routing/Routing.php?controller=groupadmin&action=finalize_registration',
                data: {
                    'password': formData.get('password'),
                    'password_confirm': formData.get('confirm-password'),
                    'newsletter': $('#cb_newsletter').is(':checked'),
                    'private': $('#cb_name_public').is(':checked'),
                    'mailmessage': $('#cb_alert_mail').is(':checked'),
                    'contact': $('#cb_allow_contact').is(':checked'),
                    'token': token
                },
                success: function (response) {
                    resolve(JSON.parse(response));
                },
                error: function () {
                    reject();
                }
            });
        });
    }
</script>