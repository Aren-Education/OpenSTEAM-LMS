<!-- page de garde -->
<div id="notif-div"></div>

<!-- Register page -->
<div id="password-change-container" style="display:none;">
    <div class="inner-register-container">
        <form action="#" id="password-change-form">
            <div class="form-group part-content-index part-row c-primary-form row">
                <div class="col-md-12">
                    <h3 class="font-weight-bold green-vitta text-center mb-4 text-uppercase" data-i18n="">Choisissez
                        votre nouveau mot de passe</h3>
                </div>
                <div class="col-md-6">
                    <div>
                        <img src="assets/media/green_lock.png" class="icon-label">
                        <label for="profile-form-password" class="tutorial-label"
                            data-i18n="[html]superadmin.profil.password"></label>
                    </div>
                    <div class="form-inline">
                        <input type="password" name="password" id="profile-form-password"
                            class="form-control form-control-lg">
                        <i class="classroom-clickable fas fa-low-vision ml-2 password-display-toggler"></i>
                        <p class="font-italic ml-2" data-i18n="superadmin.profil.passwordConstraints"></p>
                    </div>
                </div>

                <div class="col-md-6">
                    <img src="assets/media/green_lock.png" class="icon-label">
                    <label for="profile-form-confirm-password" class="tutorial-label"
                        data-i18n="[html]superadmin.profil.confirmPassword"></label>
                    <div class="form-inline">
                        <input type="password" name="confirm-password" id="profile-form-confirm-password"
                            class="form-control form-control-lg">
                        <i class="classroom-clickable fas fa-low-vision ml-2 password-display-toggler"></i>
                    </div>
                </div>
            </div>

            <div class="col-md-12 d-flex flex-column align-items-center">
                <input class="btn browse-button mx-auto mt-3 btn-lg" type="submit"
                    data-i18n="superadmin.buttons.modifie">
            </div>
        </form>
    </div>
</div>

<!-- Ecran de succès de changement de mot de passe -->
<div id="password-updated-success" style="display:none;">
    <div class="inner-login-container">
        <div class="col-12">
            <h3 class="font-weight-bold green-vitta m-auto text-center" data-i18n="">
                Votre mot de passe à été modifié
            </h3>
            <p class="text-center" data-i18n="">Cliquer sur continuer pour atteindre la page de login</p>
        </div>
        <button class="btn browse-button mx-auto mt-3 btn-lg" onclick="goToLogin()" data-i18n="">Envoyer</button>
    </div>
</div>

<!-- Ecran de demande de reset de mot de passe -->
<div id="password-recovery" style="display:none;">
    <div class="inner-login-container">
        <div class="col-12">
            <h3 class="font-weight-bold green-vitta m-auto text-center" data-i18n="">
                Entrer votre adresse e-mail
            </h3>
            <p class="text-center" data-i18n="">En cliquant sur envoyer un e-mail contenant un lien pour changer votre
                mot de passe vous sera envoyé.</p>
            <div class="col-md-12">
                <img src="assets/media/email.png" class="icon-label">
                <label for="profile-form-confirm-password" class="tutorial-label" data-i18n="">Votre E-mail</label>
                <input type="email" name="mailrecovery" id="form-email">
            </div>
        </div>
        <button class="btn browse-button mx-auto mt-3 btn-lg" onclick="sendMail()" data-i18n="">Envoyer</button>
    </div>
</div>

<!-- Ecran de succès d'envoie de mail'-->
<div id="email-send-success" style="display:none;">
    <div class="inner-login-container">
        <div class="col-12">
            <h3 class="font-weight-bold green-vitta m-auto text-center" data-i18n="">
                Un E-mail contenant la procèdure à suivre vient de vous être envoyer
            </h3>
            <p class="text-center" data-i18n="">Cliquer sur continuer pour atteindre la page de login</p>
            <p class="text-center">Si vous n'avez pas reçu l'e-mail, cliquer sur </p>
        </div>
        <button class="btn browse-button mx-auto mt-3 btn-lg" onclick="goToLogin()" data-i18n="">Envoyer</button>
    </div>
</div>




<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
    integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous">
</script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
    integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous">
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/i18next/8.1.0/i18next.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-i18next/1.2.1/jquery-i18next.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/i18next-xhr-backend/1.5.1/i18nextXHRBackend.min.js"></script>
<script
    src="https://cdnjs.cloudflare.com/ajax/libs/i18next-browser-languagedetector/2.2.3/i18nextBrowserLanguageDetector.min.js">
</script>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel@1.8.1/slick/slick.min.js"></script>
<script src="assets/js/utils/translate.js"></script>
<script src="assets/js/utils/get.js"></script>
<script src="assets/js/scripts/dashboardActivities.js"></script>
<script src="assets/js/scripts/displayPanel.js"></script>
<script src="assets/js/lib/EasyAutocomplete-1.3.5/jquery.easy-autocomplete.min.js"></script>
<script src="assets/js/scripts/signup.js"></script>
<script src="assets/js/main/Loader.js"></script>
<script src="assets/js/main/UIManager.js"></script>
<script src="assets/js/main/User.js"></script>
<script src="assets/js/main/ClassroomManager.js"></script>
<script src="assets/js/main/Main.js"></script>
<script src="assets/js/scripts/main-login.js"></script>
<script src="assets/js/scripts/login.js"></script>
<script src="assets/js/scripts/buttons.js"></script>

<script>
    if ($_GET('page')) {
        let page = $_GET('page');
        switch (page) {
            case 'update':
                $("#password-change-container").toggle();
                break;
            default:
                break;
        }
    } else {
        $('#password-recovery').toggle();
    }


    function sendMail() {
        console.log($('#form-email').val())
    }


    /**
     * Check if the teacher's account update form values are correct
     * @returns {boolean} - true if check ok, false otherwise
     */
    function passwordFormCheck(formData) {
        let formValues = {
                'password': {
                    value: formData.get('password'),
                    id: 'profile-form-password'
                },
                'confirmPassword': {
                    value: formData.get('confirm-password'),
                    id: 'profile-form-confirm-password'
                }
            },
            errors = [];
        for (let input in formValues) {
            let currentElt = document.getElementById(formValues[input].id);
            if (currentElt.classList.contains('form-input-error')) {
                currentElt.classList.remove('form-input-error');
            }
        }

        if (!formValues.password.value.length > 7) {
            errors.push('invalidPassword');
            showFormInputError(formValues.password.id);
        }

        if (formValues.password.value != formValues.confirmPassword.value) {
            errors.push('passwordAndConfirmMismatch');
            showFormInputError(formValues.password.id);
            showFormInputError(formValues.confirmPassword.id);
        }

        if (errors.length) {
            for (let error of errors) {
                displayNotification('#notif-div', `classroom.notif.${error}`, "error");
            }
            return false;
        } else {
            return true;
        }
    }

    function checkMailValid() {
        if (!$('#form-email').val().match(
                /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/
            )) {
            displayNotification('#notif-div', `classroom.notif.invalidEmail`, "error");
            return false
        }
        return true
    }

    /**
     * Create teacher form submit listener
     */
    document.getElementById('password-change-form').addEventListener('submit', (e) => {
        e.preventDefault();
        let data = new FormData(e.target);
        let token = getCookie('token');
        if (passwordFormCheck(data)) {
            finalizePasswordChange(data, token).then((response) => {
                if (response.changed == true) {
                    $("#profile-form-password").val("");
                    $("#profile-form-confirm-password").val("");
                    displayNotification('#notif-div', "classroom.notif.accountCreated", "success");
                    $('#password-change-container').toggle();
                    $('#password-updated-success').toggle();
                } else {
                    if (response.message) {
                        if (response.message == "no user") {
                            console.log(response.message);
                        } else if (response.message == "missing dataa") {
                            console.log(response.message);
                        }
                    }
                }
            });
        }
    });


    function sendMail() {
        if (checkMailValid()) {
            sendRecoveryMail().then((response) => {
                if (response.EmailSend == true) {
                    $('#email-send-success').toggle();
                    $('#password-recovery').toggle();
                } else {
                    if (response.message) {
                        console.log(response.message)
                    }
                }
            });
        }
    }

    /**
     * Create teacher account (registration)
     */
    function sendRecoveryMail(formData) {
        return new Promise((resolve, reject) => {
            $.ajax({
                type: 'POST',
                url: '/routing/Routing.php?controller=groupadmin&action=get_recovery_mail',
                data: {
                    'mail': $('#form-email').val(),
                },
                success: function (response) {
                    resolve(JSON.parse(response));
                },
                error: function () {
                    reject();
                }
            });
        });
    }


    /**
     * Create teacher account (registration)
     */
    function finalizePasswordChange(formData, token) {
        return new Promise((resolve, reject) => {
            $.ajax({
                type: 'POST',
                url: '/routing/Routing.php?controller=groupadmin&action=password_change',
                data: {
                    'password': formData.get('password'),
                    'token': token
                },
                success: function (response) {
                    resolve(JSON.parse(response));
                },
                error: function () {
                    reject();
                }
            });
        });
    }

    function goToLogin() {
        document.location = "/classroom/login.php";
    }
</script>